<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LINEé¢¨ ãƒ“ãƒ‡ã‚ªé€šè©±ï¼†ãƒãƒ£ãƒƒãƒˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        .main-container {
            display: flex;
            width: 100%;
            max-width: 1200px;
            height: 85vh;
            max-height: 900px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        /* å·¦ãƒ‘ãƒãƒ« (ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆ) */
        .left-panel {
            width: 300px;
            min-width: 250px;
            border-right: 1px solid #eee;
            background-color: #f0f0f0;
            padding: 15px;
            display: flex;
            flex-direction: column;
        }
        .header-section {
            padding-bottom: 15px;
            border-bottom: 1px solid #ddd;
            margin-bottom: 15px;
        }
        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 5px;
            margin-bottom: 8px;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            transition: all 0.2s;
        }
        .user-item:hover {
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }
        .user-info-status {
            display: flex;
            align-items: center;
        }
        .online-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .user-item.online .online-dot {
            background-color: #34c759; /* Green */
        }
        .user-item.offline .online-dot {
            background-color: #ccc; /* Gray */
        }
        .user-item button {
            background-color: #007aff; /* Blue */
            color: white;
            padding: 5px 10px;
            border-radius: 8px;
            font-size: 12px;
            transition: background-color 0.2s;
        }
        .user-item button:hover {
            background-color: #0056b3;
        }
        .users-list {
            flex-grow: 1;
            overflow-y: auto;
        }

        /* å³ãƒ‘ãƒãƒ« (ãƒãƒ£ãƒƒãƒˆ/ãƒ“ãƒ‡ã‚ª) */
        .right-panel {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        .chat-area {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            background-color: #f0f8ff; /* Light Blue Chat Background */
        }
        .input-area {
            display: flex;
            padding: 10px 20px;
            border-top: 1px solid #eee;
            background-color: white;
        }
        .input-area input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 10px;
            margin-right: 10px;
            outline: none;
        }
        .input-area button {
            background-color: #007aff;
            color: white;
            padding: 10px 15px;
            border-radius: 10px;
            transition: background-color 0.2s;
        }
        .input-area button:hover {
            background-color: #0056b3;
        }

        /* ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã‚¹ã‚¿ã‚¤ãƒ« (LINEé¢¨) */
        .message-row {
            display: flex;
            margin-bottom: 10px;
        }
        .other-message-row {
            justify-content: flex-start;
        }
        .my-message-row {
            justify-content: flex-end;
        }
        .message {
            max-width: 60%;
            padding: 10px 15px;
            border-radius: 18px;
            line-height: 1.4;
            position: relative;
            box-shadow: 0 1px 1px rgba(0, 0, 0, 0.05);
            font-size: 14px;
        }
        .other-message-row .message {
            background-color: white;
            border-bottom-left-radius: 2px;
            margin-right: 8px;
        }
        .my-message-row .message {
            background-color: #8dff8d; /* Light Green */
            border-bottom-right-radius: 2px;
            margin-left: 8px;
        }
        .timestamp {
            font-size: 10px;
            color: #999;
            align-self: flex-end;
            margin: 0 5px;
        }
        .sender-name {
            display: block;
            font-size: 10px;
            color: #555;
            margin-bottom: 3px;
            font-weight: 600;
        }

        /* ãƒ“ãƒ‡ã‚ªã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
        #call-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: black;
            display: none; /* åˆæœŸçŠ¶æ…‹ã§ã¯éè¡¨ç¤º */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        #remoteVideo {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        #localVideo {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 120px;
            height: 160px;
            border-radius: 10px;
            border: 3px solid white;
            object-fit: cover;
            z-index: 101;
        }
        .call-controls {
            position: absolute;
            bottom: 30px;
            display: flex;
            gap: 20px;
            z-index: 102;
        }
        .call-controls button {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 24px;
            transition: opacity 0.2s;
        }
        .call-controls button:hover {
            opacity: 0.8;
        }
        #hangupButton {
            background-color: #ff3b30; /* Red */
        }
        #switchCameraButton {
            background-color: #5856d6; /* Purple */
        }
        #call-status {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 1.2rem;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            z-index: 103;
        }

        /* ç€ä¿¡ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal {
            display: none;
            position: fixed;
            z-index: 200;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .modal-buttons button {
            margin: 10px;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            color: white;
        }
        #answerButton {
            background-color: #34c759;
        }
        #rejectButton {
            background-color: #ff3b30;
        }

        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ»èªè¨¼ç”»é¢ */
        .loading-spinner, #auth-status {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 30px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        #auth-status input {
            padding: 10px;
            margin: 8px 0;
            border: 1px solid #ccc;
            border-radius: 8px;
            width: 250px;
            display: block;
        }
        #auth-status button {
            background-color: #007aff;
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            margin-top: 10px;
            width: 100%;
            font-weight: bold;
        }
        .loading-spinner {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ãƒ”ãƒŠãƒ¼ (åˆæœŸè¡¨ç¤º) -->
    <div id="loading-spinner" class="loading-spinner">
        <div class="spinner"></div>
        <p>èªè¨¼ã‚’å¾…æ©Ÿã—ã¦ã„ã¾ã™...</p>
    </div>

    <!-- èªè¨¼ç”»é¢ (æœªãƒ­ã‚°ã‚¤ãƒ³æ™‚) -->
    <div id="auth-status" style="display:none;">
        <h2 class="text-xl font-bold mb-4">ã‚µã‚¤ãƒ³ã‚¤ãƒ³ / ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—</h2>
        <input type="email" id="emailInput" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" value="test@example.com">
        <input type="password" id="passwordInput" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" value="password123">
        <button id="signInButton">ã‚µã‚¤ãƒ³ã‚¤ãƒ³</button>
        <button id="signUpButton" style="background-color: #34c759;">ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—</button>
        <p class="text-xs mt-3 text-gray-500">â€»ãƒ†ã‚¹ãƒˆç”¨ã®ç°¡æ˜“èªè¨¼ã§ã™ã€‚</p>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ (ãƒ­ã‚°ã‚¤ãƒ³å¾Œ) -->
    <div id="app-container" class="main-container" style="display:none;">
        
        <!-- å·¦ã‚µã‚¤ãƒ‰ãƒ‘ãƒãƒ« (ãƒ•ãƒ¬ãƒ³ãƒ‰/ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆ) -->
        <div class="left-panel">
            <div class="header-section">
                <p id="user-info" class="font-bold text-lg mb-1"></p>
                <button id="signOutButton" class="text-sm text-red-500 hover:text-red-700 transition">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>

                <div class="mt-4 flex gap-2">
                    <input type="email" id="friendEmailInput" placeholder="ãƒ•ãƒ¬ãƒ³ãƒ‰ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" class="p-2 border rounded-lg flex-grow text-sm">
                    <button id="addFriendButton" class="text-sm px-3 py-1 bg-green-500 hover:bg-green-600 rounded-lg">è¿½åŠ </button>
                </div>
                <h3 class="font-semibold text-gray-700 mt-4">ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªã‚¹ãƒˆ</h3>
            </div>
            
            <div id="users-container" class="users-list">
                <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆãŒã“ã“ã«å‹•çš„ã«æŒ¿å…¥ã•ã‚Œã¾ã™ -->
                <p style="text-align:center; color:#999; margin-top:20px;">ãƒ•ãƒ¬ãƒ³ãƒ‰ã¨ã‚ªãƒ³ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ã‚’è¡¨ç¤º...</p>
            </div>
        </div>

        <!-- å³ãƒ¡ã‚¤ãƒ³ãƒ‘ãƒãƒ« (ãƒãƒ£ãƒƒãƒˆã¨ãƒ“ãƒ‡ã‚ª) -->
        <div class="right-panel">
            
            <!-- ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ -->
            <div id="chat-area" class="chat-area">
                <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã“ã“ã«æŒ¿å…¥ã•ã‚Œã¾ã™ -->
            </div>

            <!-- å…¥åŠ›ã‚¨ãƒªã‚¢ -->
            <div class="input-area">
                <input type="text" id="messageInput" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›...">
                <button id="sendMessageButton">é€ä¿¡</button>
            </div>
            
            <!-- ãƒ“ãƒ‡ã‚ªé€šè©±ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
            <div id="call-overlay">
                <video id="remoteVideo" autoplay playsinline></video>
                <video id="localVideo" autoplay playsinline muted></video>
                <p id="call-status">æ¥ç¶šå¾…æ©Ÿä¸­...</p>
                
                <div class="call-controls">
                    <button id="hangupButton">
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-phone-off"><path d="M10.63 2.1c.78.78 1.48 1.6 2.05 2.5l-3.37 3.37c-.38-.2-.8-.32-1.24-.37-.77-.09-1.52.16-2.07.71l-1.55 1.55c-1.26 1.26-1.53 3.36-.71 4.75.54.9 1.3 1.76 2.21 2.67l3.29 3.29c.9.9 1.76 1.67 2.67 2.21 1.4.82 3.5.55 4.75-.71l1.55-1.55c.55-.55.8-1.3.71-2.07-.05-.44-.17-.86-.37-1.24l3.37-3.37c.89-.57 1.72-1.27 2.5-2.05L22 13.7V7c0-1.1-.9-2-2-2h-6.7l-2.67 2.67Z"/></svg>
                    </button>
                    <button id="switchCameraButton">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-camera-off"><line x1="2" x2="22" y1="2" y2="22"/><path d="M16 16v1a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h2l1.6-2.4"/><path d="M10 7H21a2 2 0 0 1 2 2v8"/><path d="M15 13a3 3 0 1 0-2-2"/></svg>
                    </button>
                </div>
            </div>
            
            <!-- ç€ä¿¡ãƒ¢ãƒ¼ãƒ€ãƒ« -->
            <div id="incoming-call-modal" class="modal">
                <div class="modal-content">
                    <p id="caller-name" class="text-xl font-bold mb-5">Xxxã•ã‚“ã‹ã‚‰é›»è©±ã§ã™</p>
                    <div class="modal-buttons">
                        <button id="answerButton">å¿œç­”</button>
                        <button id="rejectButton">æ‹’å¦</button>
                    </div>
                </div>
            </div>

            <!-- ç€ä¿¡éŸ³ (ãƒ«ãƒ¼ãƒ—å†ç”Ÿã®ãŸã‚) -->
            <audio id="incomingCallSound" loop src="https://assets.mixkit.co/sfx/preview/mixkit-analog-phone-ring-2374.mp3" style="display:none;"></audio>
        </div>
    </div>
    

    <script type="module">
// =========================================================
// 1. åˆæœŸè¨­å®š (ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°)
// =========================================================
// âš  æ³¨æ„: ã“ã“ã¯å®Ÿè¡Œç’°å¢ƒã«å¿œã˜ã¦è‡ªå‹•ã§ç½®ãæ›ãˆã‚‰ã‚Œã¾ã™ã€‚
// Firebaseè¨­å®šã¨AppIDã®å–å¾—
const firebaseConfig = {
  apiKey: "AIzaSyDjDgy_QanVzmgdUs9t86qfEsTeSTXJnaY",
  authDomain: "nasuweb-467f9.firebaseapp.com",
  projectId: "nasuweb-467f9",
  storageBucket: "nasuweb-467f9.firebasestorage.app",
  messagingSenderId: "23088520786",
  appId: "1:23088520786:web:cef756e264b7f64214498b"
};
// ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«è¨­å®š (ãƒ‡ãƒãƒƒã‚°ç”¨)
firebase.firestore.setLogLevel('debug');


let currentUser = null;
let currentCallId = null; 
let localStream = null;
let peerConnection = null;
let currentFacingMode = 'user'; 
let notificationPermissionGranted = false; 

// TURNã‚µãƒ¼ãƒãƒ¼è¨­å®š (WebRTCæ¥ç¶šç”¨)
const configuration = {
    iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
        // WebRTCã®æ¥ç¶šã‚’å®‰å®šã•ã›ã‚‹ãŸã‚ã®TURNã‚µãƒ¼ãƒãƒ¼ï¼ˆãƒªãƒ¬ãƒ¼ã‚µãƒ¼ãƒãƒ¼ï¼‰
        { urls: 'turn:turn.openrelay.metered.ca:80', username: 'openrelayproject', credential: 'openrelayproject' }
    ]
};

// =========================================================
// 2. DOMè¦ç´ ã¨ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®åˆæœŸåŒ– (HTMLèª­ã¿è¾¼ã¿å¾Œå®Ÿè¡Œ)
// =========================================================
let authStatusDiv, appContainer, loadingSpinner, usersContainer, 
    signInButton, signUpButton, signOutButton, 
    sendMessageButton, switchCameraButton, hangupButton, 
    answerButton, rejectButton, addFriendButton, friendEmailInput, incomingCallSound,
    localVideo, remoteVideo, callOverlay, callStatus, incomingModal; 

window.onload = function() {
    // DOMè¦ç´ ã®å–å¾—
    authStatusDiv = document.getElementById('auth-status');
    appContainer = document.getElementById('app-container');
    loadingSpinner = document.getElementById('loading-spinner');
    usersContainer = document.getElementById('users-container');

    signInButton = document.getElementById('signInButton');
    signUpButton = document.getElementById('signUpButton');
    signOutButton = document.getElementById('signOutButton');
    sendMessageButton = document.getElementById('sendMessageButton');
    switchCameraButton = document.getElementById('switchCameraButton');
    hangupButton = document.getElementById('hangupButton');
    answerButton = document.getElementById('answerButton');
    rejectButton = document.getElementById('rejectButton');
    addFriendButton = document.getElementById('addFriendButton'); 
    friendEmailInput = document.getElementById('friendEmailInput'); 
    incomingCallSound = document.getElementById('incomingCallSound'); 
    
    localVideo = document.getElementById('localVideo');
    remoteVideo = document.getElementById('remoteVideo');
    callOverlay = document.getElementById('call-overlay');
    callStatus = document.getElementById('call-status');
    incomingModal = document.getElementById('incoming-call-modal');


    // UIã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
    signInButton.addEventListener('click', () => {
        const email = document.getElementById('emailInput').value;
        const password = document.getElementById('passwordInput').value;
        auth.signInWithEmailAndPassword(email, password).catch(e => console.error("ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:", e.message));
    });

    signUpButton.addEventListener('click', () => {
        const email = document.getElementById('emailInput').value;
        const password = document.getElementById('passwordInput').value;
        auth.createUserWithEmailAndPassword(email, password).catch(e => console.error("ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼:", e.message));
    });

    signOutButton.addEventListener('click', () => {
        if (currentUser) {
            // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ™‚ã«usersã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰è‡ªåˆ†ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤
            // ğŸš¨ ã€Firestore ãƒ‘ã‚¹ä¿®æ­£ã€‘usersã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒ‘ãƒ–ãƒªãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ãƒ‘ã‚¹ã«ç§»å‹•
            db.collection('artifacts').doc(appId).collection('public').doc('data').collection('users').doc(currentUser.uid).delete().catch(console.error);
        }
        auth.signOut();
    });

    sendMessageButton.addEventListener('click', sendMessage);
    switchCameraButton.addEventListener('click', switchCamera); 
    hangupButton.addEventListener('click', endCall); 
    answerButton.addEventListener('click', answerCall); 
    rejectButton.addEventListener('click', rejectCall); 
    addFriendButton.addEventListener('click', addFriendByEmail); 

    // Firebaseèªè¨¼çŠ¶æ…‹ã®ç›£è¦–ã‚’é–‹å§‹
    startAuthListener();
}


// =========================================================
// 3. èªè¨¼ & ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç† & ãƒ•ãƒ¬ãƒ³ãƒ‰æ©Ÿèƒ½
// =========================================================

function startAuthListener() {
    auth.onAuthStateChanged(async (user) => {
        // èªè¨¼çŠ¶æ…‹ãŒç¢ºå®šã—ãŸæ™‚ç‚¹ã§ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’éè¡¨ç¤ºã«ã™ã‚‹
        loadingSpinner.style.display = 'none';

        if (user) {
            currentUser = user;
            document.getElementById('user-info').textContent = user.email;
            
            // ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ãªã‚‰ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚’è¡¨ç¤º
            authStatusDiv.style.display = 'none';
            appContainer.style.display = 'flex';

            // é€šçŸ¥æ¨©é™ã‚’è¦æ±‚ (æ–°è¦è¿½åŠ )
            await requestNotificationPermission(); 

            // è‡ªåˆ†ã®æƒ…å ±ã‚’usersã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«ä¿å­˜ (ã‚ªãƒ³ãƒ©ã‚¤ãƒ³é€šçŸ¥ä»£ã‚ã‚Š)
            // ğŸš¨ ã€Firestore ãƒ‘ã‚¹ä¿®æ­£ã€‘usersã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒ‘ãƒ–ãƒªãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ãƒ‘ã‚¹ã«ç§»å‹•
            await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('users').doc(user.uid).set({
                email: user.email,
                uid: user.uid,
                lastSeen: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });

            startChatListener();   
            startUserListListener(); 
            startIncomingCallListener(); 
        } else {
            currentUser = null;
            // æœªãƒ­ã‚°ã‚¤ãƒ³ãªã‚‰èªè¨¼ç”»é¢ã‚’è¡¨ç¤º
            authStatusDiv.style.display = 'block';
            appContainer.style.display = 'none';
        }
    });
}

// ãƒ–ãƒ©ã‚¦ã‚¶é€šçŸ¥æ¨©é™ã‚’è¦æ±‚ã™ã‚‹é–¢æ•° (æ–°è¦è¿½åŠ )
async function requestNotificationPermission() {
    if (!('Notification' in window)) {
        console.warn("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯é€šçŸ¥ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚");
        return;
    }

    if (Notification.permission === 'granted') {
        notificationPermissionGranted = true;
        return;
    }

    if (Notification.permission !== 'denied') {
        try {
            const permission = await Notification.requestPermission();
            if (permission === 'granted') {
                notificationPermissionGranted = true;
                console.log("é€šçŸ¥æ¨©é™ãŒè¨±å¯ã•ã‚Œã¾ã—ãŸã€‚");
            } else {
                notificationPermissionGranted = false;
                console.log("é€šçŸ¥æ¨©é™ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚");
            }
        } catch (error) {
            console.error("é€šçŸ¥æ¨©é™ã®è¦æ±‚ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", error);
            notificationPermissionGranted = false;
        }
    }
}

// ãƒ–ãƒ©ã‚¦ã‚¶é€šçŸ¥ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•° (æ–°è¦è¿½åŠ )
function displayNotification(title, body) {
    if (notificationPermissionGranted) {
        // ãƒšãƒ¼ã‚¸ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªå ´åˆã€é€šçŸ¥ã¯ä¸è¦
        if (document.visibilityState === 'visible' && callOverlay.style.display !== 'flex') {
            return;
        }

        const notification = new Notification(title, {
            body: body,
            icon: 'https://placehold.co/64x64/00c300/ffffff?text=L', 
            vibrate: [200, 100, 200]
        });
        
        // é€šçŸ¥ã‚¯ãƒªãƒƒã‚¯æ™‚ã«ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
        notification.onclick = function() {
            window.focus();
            this.close();
        };
    }
}

// ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ãƒ•ãƒ¬ãƒ³ãƒ‰ã‚’è¿½åŠ ã™ã‚‹ (Firestoreãƒ‘ã‚¹ä¿®æ­£æ¸ˆã¿)
async function addFriendByEmail() {
    const email = friendEmailInput.value.trim();
    if (!email || email === currentUser.email) {
        return;
    }

    try {
        // 1. ãã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æŒã¤ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ¤œç´¢
        // ğŸš¨ ã€Firestore ãƒ‘ã‚¹ä¿®æ­£ã€‘usersã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒ‘ãƒ–ãƒªãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ãƒ‘ã‚¹ã«ç§»å‹•
        const usersRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('users');
        const usersSnapshot = await usersRef.where('email', '==', email).limit(1).get();

        if (usersSnapshot.empty) {
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡ºã™
            console.log("ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
            return;
        }

        const friendDoc = usersSnapshot.docs[0];
        const friendUid = friendDoc.id;

        // 2. è‡ªåˆ†ã®ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªã‚¹ãƒˆã«è¿½åŠ 
        // ğŸš¨ ã€Firestore ãƒ‘ã‚¹ä¿®æ­£ã€‘friendsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒ‘ãƒ–ãƒªãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ãƒ‘ã‚¹ã«ç§»å‹•
        const friendsRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('friends').doc(currentUser.uid).collection('list');
        await friendsRef.doc(friendUid).set({
            uid: friendUid,
            email: email,
            addedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        console.log(`${email} ã‚’ãƒ•ãƒ¬ãƒ³ãƒ‰ã«è¿½åŠ ã—ã¾ã—ãŸï¼`);
        friendEmailInput.value = '';

    } catch (e) {
        console.error("ãƒ•ãƒ¬ãƒ³ãƒ‰è¿½åŠ ã‚¨ãƒ©ãƒ¼:", e);
    }
}

// ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªã‚¹ãƒˆã®ç›£è¦–ã¨è¡¨ç¤º
function startUserListListener() {
    const onlineUsers = {}; 
    let friends = {};       

    // 1. ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç›£è¦–
    // ğŸš¨ ã€Firestore ãƒ‘ã‚¹ä¿®æ­£ã€‘usersã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒ‘ãƒ–ãƒªãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ãƒ‘ã‚¹ã«ç§»å‹•
    const usersRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('users');
    usersRef.onSnapshot(onlineSnapshot => {
        // onlineUsersã‚’ãƒªã‚»ãƒƒãƒˆ
        Object.keys(onlineUsers).forEach(key => delete onlineUsers[key]); 
        onlineSnapshot.forEach(doc => {
            const userData = doc.data();
            if (userData.uid !== currentUser.uid) {
                onlineUsers[userData.uid] = userData;
            }
        });
        renderFriendList(friends, onlineUsers);
    });

    // 2. è‡ªåˆ†ã®ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªã‚¹ãƒˆã®ç›£è¦–
    // ğŸš¨ ã€Firestore ãƒ‘ã‚¹ä¿®æ­£ã€‘friendsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒ‘ãƒ–ãƒªãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ãƒ‘ã‚¹ã«ç§»å‹•
    const friendsListRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('friends').doc(currentUser.uid).collection('list');
    friendsListRef.onSnapshot(friendSnapshot => {
        // friendsã‚’ãƒªã‚»ãƒƒãƒˆ
        Object.keys(friends).forEach(key => delete friends[key]);
        friendSnapshot.forEach(doc => {
            const friendData = doc.data();
            friends[friendData.uid] = friendData;
        });
        renderFriendList(friends, onlineUsers);
    });
}

// ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªã‚¹ãƒˆã®DOMæç”»
function renderFriendList(friends, onlineUsers) {
    usersContainer.innerHTML = '';
    
    const friendUids = Object.keys(friends);

    if (friendUids.length === 0) {
        usersContainer.innerHTML = '<p style="text-align:center; color:#999; margin-top:20px;">ã¾ã ãƒ•ãƒ¬ãƒ³ãƒ‰ãŒã„ã¾ã›ã‚“ã€‚ã€Œãƒ•ãƒ¬ãƒ³ãƒ‰ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã€ã‚’å…¥åŠ›ã—ã¦è¿½åŠ ã—ã¾ã—ã‚‡ã†ã€‚</p>';
        return;
    }

    friendUids.forEach(uid => {
        const friendData = friends[uid];
        const isOnline = !!onlineUsers[uid]; 
        const displayData = isOnline ? onlineUsers[uid] : friendData;
        
        const div = document.createElement('div');
        div.className = `user-item ${isOnline ? 'online' : 'offline'}`;
        div.innerHTML = `
            <div class="user-info-status">
                <span class="online-dot"></span>
                <span>${displayData.email.split('@')[0]} ${isOnline ? '(Online)' : '(Offline)'}</span>
            </div>
            ${isOnline 
                ? `<button onclick="startCall('${displayData.uid}', '${displayData.email}')">ğŸ“ é€šè©±</button>`
                : `<button onclick="removeFriend('${displayData.uid}', '${displayData.email}')" style="background-color: #ff3b30;">å‰Šé™¤</button>`
            }
        `;
        usersContainer.appendChild(div);
    });
}

// ãƒ•ãƒ¬ãƒ³ãƒ‰å‰Šé™¤
window.removeFriend = async (friendUid, friendEmail) => {
    // confirmã®ä»£ã‚ã‚Šã«ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„
    const confirmed = window.prompt(`${friendEmail.split('@')[0]} ã•ã‚“ã‚’ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ (ã¯ã„/ã„ã„ãˆ)`);
    if (confirmed && confirmed.toLowerCase() === 'ã¯ã„') {
        try {
            // ğŸš¨ ã€Firestore ãƒ‘ã‚¹ä¿®æ­£ã€‘friendsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒ‘ãƒ–ãƒªãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ãƒ‘ã‚¹ã«ç§»å‹•
            await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('friends').doc(currentUser.uid).collection('list').doc(friendUid).delete();
            console.log(`${friendEmail} ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚`);
        } catch(e) {
            console.error("ãƒ•ãƒ¬ãƒ³ãƒ‰å‰Šé™¤ã‚¨ãƒ©ãƒ¼:", e);
        }
    }
}


// =========================================================
// 4. ãƒãƒ£ãƒƒãƒˆ
// =========================================================

// ãƒãƒ£ãƒƒãƒˆé€ä¿¡
function sendMessage() {
    const input = document.getElementById('messageInput');
    const text = input.value.trim();
    if (text && currentUser) {
        // ğŸš¨ ã€Firestore ãƒ‘ã‚¹ä¿®æ­£ã€‘chatsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒ‘ãƒ–ãƒªãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ãƒ‘ã‚¹ã«ç§»å‹•
        db.collection('artifacts').doc(appId).collection('public').doc('data').collection('chats').add({
            text: text,
            uid: currentUser.uid,
            email: currentUser.email,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
        input.value = '';
    }
}

// ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ "hh:mm" å½¢å¼ã«æ•´å½¢ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
function formatTimestamp(timestamp) {
    if (!timestamp) return '';
    const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
    const hours = date.getHours().toString().padStart(2, '0');
    const minutes = date.getMinutes().toString().padStart(2, '0');
    return `${hours}:${minutes}`;
}

// ãƒãƒ£ãƒƒãƒˆå—ä¿¡ (LINEé¢¨è¡¨ç¤º)
function startChatListener() {
    const chatArea = document.getElementById('chat-area');
    // ğŸš¨ ã€Firestore ãƒ‘ã‚¹ä¿®æ­£ã€‘chatsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒ‘ãƒ–ãƒªãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ãƒ‘ã‚¹ã«ç§»å‹•
    db.collection('artifacts').doc(appId).collection('public').doc('data').collection('chats').orderBy('timestamp', 'asc').limit(50).onSnapshot(snapshot => {
        let newMessages = [];

        snapshot.docChanges().forEach(change => {
            // æ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¿½åŠ ã•ã‚ŒãŸå ´åˆ
            if (change.type === 'added') {
                const data = change.doc.data();
                // è‡ªåˆ†ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ã¯ãªãã€ã‹ã¤ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æœ¬æ–‡ãŒã‚ã‚‹å ´åˆã€é€šçŸ¥ãƒªã‚¹ãƒˆã«è¿½åŠ 
                if (data.uid !== currentUser.uid && data.text) {
                    newMessages.push(data);
                }
            }
        });

        // å·®åˆ†ã§è¿½åŠ ã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚Œã°é€šçŸ¥
        if (newMessages.length > 0) {
            newMessages.forEach(data => {
                const senderName = data.email ? data.email.split('@')[0] : 'ã‚²ã‚¹ãƒˆ';
                displayNotification(senderName, data.text);
            });
        }


        // UIã®å†æç”»
        chatArea.innerHTML = '';
        snapshot.forEach(doc => {
            const data = doc.data();
            
            if (!data.text || typeof data.text !== 'string') return; 

            try { 
                const isMe = data.uid === currentUser.uid;
                const userName = data.email ? data.email.split('@')[0] : 'ã‚²ã‚¹ãƒˆ';
                const timeString = formatTimestamp(data.timestamp); 
                
                const rowDiv = document.createElement('div');
                rowDiv.className = `message-row ${isMe ? 'my-message-row' : 'other-message-row'}`;
                
                const timeSpan = document.createElement('span');
                timeSpan.className = 'timestamp';
                timeSpan.textContent = timeString;

                const msgDiv = document.createElement('div');
                msgDiv.className = 'message';
                
                if (!isMe) {
                    const nameSpan = document.createElement('span');
                    nameSpan.className = 'sender-name';
                    nameSpan.textContent = userName;
                    msgDiv.appendChild(nameSpan);
                }
                
                const textNode = document.createTextNode(data.text);
                msgDiv.appendChild(textNode);
                
                // è‡ªåˆ†ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯æ™‚é–“è¡¨ç¤ºã‚’å·¦ã«ã€ç›¸æ‰‹ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯æ™‚é–“è¡¨ç¤ºã‚’å³ã«
                if (isMe) {
                    rowDiv.appendChild(timeSpan);
                    rowDiv.appendChild(msgDiv);
                } else {
                    rowDiv.appendChild(msgDiv);
                    rowDiv.appendChild(timeSpan);
                }

                chatArea.appendChild(rowDiv);
            } catch (e) {
                console.error("ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¡¨ç¤ºä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", e, data);
            }
        });
        chatArea.scrollTop = chatArea.scrollHeight;
    });
}


// =========================================================
// 5. 1å¯¾1 WebRTC é€šè©±æ©Ÿèƒ½
// =========================================================

// ã‚«ãƒ¡ãƒ©å–å¾—é–¢æ•° (facingModeå¯¾å¿œ)
async function getLocalStream() {
    try {
        const constraints = {
            audio: true,
            video: { facingMode: currentFacingMode }
        };
        localStream = await navigator.mediaDevices.getUserMedia(constraints);
        localVideo.srcObject = localStream;
        return true;
    } catch (e) {
        console.error("ã‚«ãƒ¡ãƒ©å–å¾—ã‚¨ãƒ©ãƒ¼", e);
        return false;
    }
}

// é€šè©±é–‹å§‹ (ç™ºä¿¡)
window.startCall = async (targetUid, targetEmail) => {
    if (!await getLocalStream()) return;
    
    // 1å¯¾1ç”¨ã®é€šè©±IDã‚’ä½œæˆ (è¾æ›¸é †ã§ä¸¦ã¹æ›¿ãˆ)
    const uids = [currentUser.uid, targetUid].sort();
    currentCallId = `${uids[0]}_${uids[1]}`;
    
    // UIè¡¨ç¤º
    callOverlay.style.display = 'flex';
    callStatus.textContent = `${targetEmail.split('@')[0]} ã•ã‚“ã«ç™ºä¿¡ä¸­...`;
    
    setupPeerConnection();
    
    // ğŸš¨ ã€Firestore ãƒ‘ã‚¹ä¿®æ­£ã€‘callsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒ‘ãƒ–ãƒªãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ãƒ‘ã‚¹ã«ç§»å‹•
    const callDoc = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('calls').doc(currentCallId);
    
    // éå»ã®ã‚´ãƒŸãƒ‡ãƒ¼ã‚¿ã‚’æƒé™¤
    const candidates = await callDoc.collection('candidates').get();
    candidates.forEach(doc => doc.ref.delete());
    
    // Offerä½œæˆ
    const offer = await peerConnection.createOffer();
    await peerConnection.setLocalDescription(offer);
    
    // ç™ºä¿¡æƒ…å ±ã‚’æ›¸ãè¾¼ã¿ 
    await callDoc.set({
        offer: { type: offer.type, sdp: offer.sdp },
        callerUid: currentUser.uid,
        calleeUid: targetUid, 
        answer: null
    });

    // Answerå¾…ã¡å—ã‘
    const unsubscribe = callDoc.onSnapshot(async (snapshot) => {
        const data = snapshot.data();
        if (data && data.answer && !peerConnection.currentRemoteDescription) {
            const answerDesc = new RTCSessionDescription(data.answer);
            await peerConnection.setRemoteDescription(answerDesc);
            callStatus.textContent = 'æ¥ç¶šã—ã¾ã—ãŸ';
            unsubscribe();
        }
    });
};

// ç€ä¿¡ç›£è¦– (è‡ªåˆ†å®›ã¦ã®é›»è©±ã ã‘ã‚’æ‹¾ã†)
function startIncomingCallListener() {
    // ğŸš¨ ã€Firestore ãƒ‘ã‚¹ä¿®æ­£ã€‘callsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒ‘ãƒ–ãƒªãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ãƒ‘ã‚¹ã«ç§»å‹•
    db.collection('artifacts').doc(appId).collection('public').doc('data').collection('calls').onSnapshot(snapshot => {
        snapshot.docChanges().forEach(change => {
            if (change.type === 'added' || change.type === 'modified') {
                const data = change.doc.data();
                
                if (data.calleeUid === currentUser.uid && data.offer && !data.answer) {
                    if (callOverlay.style.display !== 'flex') {
                        // ç€ä¿¡éŸ³ã¨é€šçŸ¥
                        try { incomingCallSound.play(); } catch(e) { console.warn("ç€ä¿¡éŸ³å†ç”Ÿã‚¨ãƒ©ãƒ¼:", e); }
                        
                        // ğŸš¨ ã€Firestore ãƒ‘ã‚¹ä¿®æ­£ã€‘usersã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒ‘ãƒ–ãƒªãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ãƒ‘ã‚¹ã«ç§»å‹•
                        db.collection('artifacts').doc(appId).collection('public').doc('data').collection('users').doc(data.callerUid).get().then(doc => {
                            const callerEmail = doc.data()?.email || 'ä¸æ˜ãªãƒ¦ãƒ¼ã‚¶ãƒ¼';
                            const callerName = callerEmail.split('@')[0];
                            
                            // ãƒ–ãƒ©ã‚¦ã‚¶é€šçŸ¥ã‚’è¡¨ç¤º (æ–°è¦è¿½åŠ )
                            displayNotification(`ğŸ“ ç€ä¿¡ (${callerName}ã•ã‚“)`, `${callerName}ã•ã‚“ã‹ã‚‰é€šè©±ãŒã‹ã‹ã£ã¦ãã¾ã—ãŸã€‚`);
                            
                            showIncomingCallModal(change.doc.id, callerName);
                        });
                    }
                }
            }
        });
    });
}

// ç€ä¿¡ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
let incomingCallId = null;
function showIncomingCallModal(callId, callerName) {
    incomingCallId = callId;
    document.getElementById('caller-name').textContent = `${callerName} ã•ã‚“ã‹ã‚‰é›»è©±ã§ã™`;
    incomingModal.style.display = 'flex'; // display: block ã‹ã‚‰ flex ã«å¤‰æ›´
}

// å¿œç­”ãƒœã‚¿ãƒ³å‡¦ç†
async function answerCall() {
    incomingModal.style.display = 'none';
    incomingCallSound.pause(); 
    incomingCallSound.currentTime = 0;
    
    currentCallId = incomingCallId;
    
    if (!await getLocalStream()) return;
    
    callOverlay.style.display = 'flex';
    callStatus.textContent = 'æ¥ç¶šä¸­...';
    
    setupPeerConnection();
    
    // ğŸš¨ ã€Firestore ãƒ‘ã‚¹ä¿®æ­£ã€‘callsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒ‘ãƒ–ãƒªãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ãƒ‘ã‚¹ã«ç§»å‹•
    const callDoc = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('calls').doc(currentCallId);
    const doc = await callDoc.get();
    const data = doc.data();
    
    // Offerè¨­å®š
    await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
    
    // Answerä½œæˆ
    const answer = await peerConnection.createAnswer();
    await peerConnection.setLocalDescription(answer);
    
    await callDoc.update({
        answer: { type: answer.type, sdp: answer.sdp }
    });
}

// æ‹’å¦ãƒœã‚¿ãƒ³å‡¦ç†
function rejectCall() {
    incomingModal.style.display = 'none';
    incomingCallSound.pause(); 
    incomingCallSound.currentTime = 0;

    if (incomingCallId) {
         // ğŸš¨ ã€Firestore ãƒ‘ã‚¹ä¿®æ­£ã€‘callsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒ‘ãƒ–ãƒªãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ãƒ‘ã‚¹ã«ç§»å‹•
         db.collection('artifacts').doc(appId).collection('public').doc('data').collection('calls').doc(incomingCallId).delete().catch(console.error);
    }
}


// PeerConnectionå…±é€šã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
function setupPeerConnection() {
    if (peerConnection) peerConnection.close();
    peerConnection = new RTCPeerConnection(configuration);
    
    if (localStream) {
        localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
    }
    
    peerConnection.ontrack = event => {
        remoteVideo.srcObject = event.streams[0];
    };
    
    // ICE Candidateå‡¦ç†
    // ğŸš¨ ã€Firestore ãƒ‘ã‚¹ä¿®æ­£ã€‘callsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒ‘ãƒ–ãƒªãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ãƒ‘ã‚¹ã«ç§»å‹•
    const callDoc = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('calls').doc(currentCallId);
    
    peerConnection.onicecandidate = event => {
        if (event.candidate) {
            callDoc.collection('candidates').add(event.candidate.toJSON());
        }
    };
    
    // ICE Candidateã®å—ä¿¡
    callDoc.collection('candidates').onSnapshot(snapshot => {
        snapshot.docChanges().forEach(async change => {
            if (change.type === 'added') {
                const candidate = new RTCIceCandidate(change.doc.data());
                // ãƒªãƒ¢ãƒ¼ãƒˆè¨­å®šå¾Œã®ã¿Candidateã‚’è¿½åŠ 
                if (peerConnection && peerConnection.remoteDescription) {
                    try { await peerConnection.addIceCandidate(candidate); }
                    catch (e) { console.error("Candidateè¿½åŠ ã‚¨ãƒ©ãƒ¼:", e); }
                } else {
                     console.log("ãƒªãƒ¢ãƒ¼ãƒˆè¨˜è¿°è¨­å®šå‰ãªã®ã§Candidateã®è¿½åŠ ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸã€‚");
                }
            }
        });
    });
    
    // åˆ‡æ–­ç›£è¦–
    peerConnection.onconnectionstatechange = () => {
        if (peerConnection.connectionState === 'disconnected' || peerConnection.connectionState === 'failed') {
            endCall();
        }
    };
}


// =========================================================
// 6. ã‚«ãƒ¡ãƒ©åˆ‡ã‚Šæ›¿ãˆ & é€šè©±çµ‚äº†
// =========================================================

// ã‚«ãƒ¡ãƒ©åˆ‡ã‚Šæ›¿ãˆ (ã‚¹ãƒãƒ›ç”¨)
async function switchCamera() {
    currentFacingMode = currentFacingMode === 'user' ? 'environment' : 'user';
    
    if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
    }
    
    await getLocalStream();
    
    // PeerConnectionã®æ˜ åƒãƒˆãƒ©ãƒƒã‚¯ã‚’å·®ã—æ›¿ãˆã‚‹
    if (peerConnection && localStream) {
        const videoTrack = localStream.getVideoTracks()[0];
        const sender = peerConnection.getSenders().find(s => s.track && s.track.kind === 'video');
        if (sender) {
            sender.replaceTrack(videoTrack);
        }
    }
}

// é€šè©±çµ‚äº†
function endCall() {
    if (peerConnection) peerConnection.close();
    if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
    }
    callOverlay.style.display = 'none';
    localStream = null;
    peerConnection = null;
    currentCallId = null;
    
    incomingCallSound.pause(); 
    incomingCallSound.currentTime = 0;

    // UIã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆã‚’å†èª­ã¿è¾¼ã¿
    document.getElementById('users-container').innerHTML = '';
    if (currentUser) {
        startUserListListener();
    }
}

    </script>
</body>
</html>

