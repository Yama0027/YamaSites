
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LINEé¢¨ ãƒ“ãƒ‡ã‚ªé€šè©±ï¼†ãƒãƒ£ãƒƒãƒˆ</title>
    <!-- Tailwind CSSã‚’èª­ã¿è¾¼ã¿ -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDKã‚’CDNã§èª­ã¿è¾¼ã¿ -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <!-- WebRTCè¨­å®š (TURNã‚µãƒ¼ãƒãƒ¼æƒ…å ±) ã‚’èª­ã¿è¾¼ã‚€ -->
    <script src="./config.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        .main-container {
            display: flex;
            width: 100%;
            max-width: 1200px;
            height: 85vh;
            max-height: 900px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        /* å·¦ãƒ‘ãƒãƒ« (ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆ) */
        .left-panel {
            width: 300px;
            min-width: 250px;
            border-right: 1px solid #eee;
            background-color: #f0f0f0;
            padding: 15px;
            display: flex;
            flex-direction: column;
        }
        .header-section {
            padding-bottom: 15px;
            border-bottom: 1px solid #ddd;
            margin-bottom: 15px;
        }
        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 5px;
            margin-bottom: 8px;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            transition: all 0.2s;
        }
        .user-item:hover {
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }
        .user-info-status {
            display: flex;
            align-items: center;
        }
        .online-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .user-item.online .online-dot {
            background-color: #34c759; /* Green */
        }
        .user-item.offline .online-dot {
            background-color: #ccc; /* Gray */
        }
        .user-item button {
            background-color: #007aff; /* Blue */
            color: white;
            padding: 5px 10px;
            border-radius: 8px;
            font-size: 12px;
            transition: background-color 0.2s;
            cursor: pointer;
        }
        .user-item button:hover {
            background-color: #0056b3;
        }
        .users-list {
            flex-grow: 1;
            overflow-y: auto;
        }

        /* å³ãƒ‘ãƒãƒ« (ãƒãƒ£ãƒƒãƒˆ/ãƒ“ãƒ‡ã‚ª) */
        .right-panel {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        .chat-area {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            background-color: #f0f8ff; /* Light Blue Chat Background */
        }
        .input-area {
            display: flex;
            padding: 10px 20px;
            border-top: 1px solid #eee;
            background-color: white;
        }
        .input-area input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 10px;
            margin-right: 10px;
            outline: none;
        }
        .input-area button {
            background-color: #007aff;
            color: white;
            padding: 10px 15px;
            border-radius: 10px;
            transition: background-color 0.2s;
            cursor: pointer;
        }
        .input-area button:hover {
            background-color: #0056b3;
        }

        /* ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã‚¹ã‚¿ã‚¤ãƒ« (LINEé¢¨) */
        .message-row {
            display: flex;
            margin-bottom: 10px;
        }
        .other-message-row {
            justify-content: flex-start;
        }
        .my-message-row {
            justify-content: flex-end;
        }
        .message {
            max-width: 60%;
            padding: 10px 15px;
            border-radius: 18px;
            line-height: 1.4;
            position: relative;
            box-shadow: 0 1px 1px rgba(0, 0, 0, 0.05);
            font-size: 14px;
        }
        .other-message-row .message {
            background-color: white;
            border-bottom-left-radius: 2px;
            margin-right: 8px;
        }
        .my-message-row .message {
            background-color: #8dff8d; /* Light Green */
            border-bottom-right-radius: 2px;
            margin-left: 8px;
        }
        .timestamp {
            font-size: 10px;
            color: #999;
            align-self: flex-end;
            margin: 0 5px;
        }
        .sender-name {
            display: block;
            font-size: 10px;
            color: #555;
            margin-bottom: 3px;
            font-weight: 600;
        }

        /* ãƒ“ãƒ‡ã‚ªã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
        #call-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: black;
            display: none; /* åˆæœŸçŠ¶æ…‹ã§ã¯éè¡¨ç¤º */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        #remoteVideo {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        #localVideo {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 120px;
            height: 160px;
            border-radius: 10px;
            border: 3px solid white;
            object-fit: cover;
            z-index: 101;
        }
        .call-controls {
            position: absolute;
            bottom: 30px;
            display: flex;
            gap: 20px;
            z-index: 102;
        }
        .call-controls button {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 24px;
            transition: opacity 0.2s;
            cursor: pointer;
        }
        .call-controls button:hover {
            opacity: 0.8;
        }
        #hangupButton {
            background-color: #ff3b30; /* Red */
        }
        #switchCameraButton {
            background-color: #5856d6; /* Purple */
        }
        #call-status {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 1.2rem;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            z-index: 103;
        }

        /* ç€ä¿¡ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal {
            display: none;
            position: fixed;
            z-index: 200;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .modal-buttons button {
            margin: 10px;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            color: white;
            cursor: pointer;
        }
        #answerButton {
            background-color: #34c759;
        }
        #rejectButton {
            background-color: #ff3b30;
        }

        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ»èªè¨¼ç”»é¢ */
        .loading-spinner, #auth-status {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 30px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        #auth-status input {
            padding: 10px;
            margin: 8px 0;
            border: 1px solid #ccc;
            border-radius: 8px;
            width: 250px;
            display: block;
        }
        #auth-status button {
            background-color: #007aff;
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            margin-top: 10px;
            width: 100%;
            font-weight: bold;
            cursor: pointer;
        }
        .loading-spinner {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ãƒ”ãƒŠãƒ¼ (åˆæœŸè¡¨ç¤º) -->
    <div id="loading-spinner" class="loading-spinner">
        <div class="spinner"></div>
        <p>èªè¨¼ã‚’å¾…æ©Ÿã—ã¦ã„ã¾ã™...</p>
    </div>

    <!-- èªè¨¼ç”»é¢ (æœªãƒ­ã‚°ã‚¤ãƒ³æ™‚) -->
    <div id="auth-status" style="display:none;">
        <h2 class="text-xl font-bold mb-4">ã‚µã‚¤ãƒ³ã‚¤ãƒ³ / ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—</h2>
        <!-- ãƒ‡ãƒ¢ç”¨ã«ãƒ†ã‚¹ãƒˆã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’äº‹å‰å…¥åŠ› -->
        <input type="email" id="emailInput" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" value="test@example.com">
        <input type="password" id="passwordInput" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" value="password123">
        <button id="signInButton">ã‚µã‚¤ãƒ³ã‚¤ãƒ³</button>
        <button id="signUpButton" style="background-color: #34c759;">ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—</button>
        <p class="text-xs mt-3 text-gray-500">â€»ãƒ†ã‚¹ãƒˆç”¨ã®ç°¡æ˜“èªè¨¼ã§ã™ã€‚</p>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ (ãƒ­ã‚°ã‚¤ãƒ³å¾Œ) -->
    <div id="app-container" class="main-container" style="display:none;">
        
        <!-- å·¦ã‚µã‚¤ãƒ‰ãƒ‘ãƒãƒ« (ãƒ•ãƒ¬ãƒ³ãƒ‰/ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆ) -->
        <div class="left-panel">
            <div class="header-section">
                <p id="user-info" class="font-bold text-lg mb-1"></p>
                <button id="signOutButton" class="text-sm text-red-500 hover:text-red-700 transition">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>

                <div class="mt-4 flex gap-2">
                    <input type="email" id="friendEmailInput" placeholder="ãƒ•ãƒ¬ãƒ³ãƒ‰ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" class="p-2 border rounded-lg flex-grow text-sm">
                    <button id="addFriendButton" class="text-sm px-3 py-1 bg-green-500 hover:bg-green-600 rounded-lg">è¿½åŠ </button>
                </div>
                <h3 class="font-semibold text-gray-700 mt-4">ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªã‚¹ãƒˆ</h3>
            </div>
            
            <div id="users-container" class="users-list">
                <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆãŒã“ã“ã«å‹•çš„ã«æŒ¿å…¥ã•ã‚Œã¾ã™ -->
                <p style="text-align:center; color:#999; margin-top:20px;">ãƒ•ãƒ¬ãƒ³ãƒ‰ã¨ã‚ªãƒ³ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ã‚’è¡¨ç¤º...</p>
            </div>
        </div>

        <!-- å³ãƒ¡ã‚¤ãƒ³ãƒ‘ãƒãƒ« (ãƒãƒ£ãƒƒãƒˆã¨ãƒ“ãƒ‡ã‚ª) -->
        <div class="right-panel">
            
            <!-- ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ -->
            <div id="chat-area" class="chat-area">
                <!-- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã“ã“ã«æŒ¿å…¥ã•ã‚Œã¾ã™ -->
            </div>

            <!-- å…¥åŠ›ã‚¨ãƒªã‚¢ -->
            <div class="input-area">
                <input type="text" id="messageInput" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›...">
                <button id="sendMessageButton">é€ä¿¡</button>
            </div>
            
            <!-- ãƒ“ãƒ‡ã‚ªé€šè©±ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
            <div id="call-overlay">
                <video id="remoteVideo" autoplay playsinline></video>
                <video id="localVideo" autoplay playsinline muted></video>
                <p id="call-status">æ¥ç¶šå¾…æ©Ÿä¸­...</p>
                
                <div class="call-controls">
                    <button id="hangupButton">
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-phone-off"><path d="M10.63 2.1c.78.78 1.48 1.6 2.05 2.5l-3.37 3.37c-.38-.2-.8-.32-1.24-.37-.77-.09-1.52.16-2.07.71l-1.55 1.55c-1.26 1.26-1.53 3.36-.71 4.75.54.9 1.3 1.76 2.21 2.67l3.29 3.29c.9.9 1.76 1.67 2.67 2.21 1.4.82 3.5.55 4.75-.71l1.55-1.55c.55-.55.8-1.3.71-2.07-.05-.44-.17-.86-.37-1.24l3.37-3.37c.89-.57 1.72-1.27 2.5-2.05L22 13.7V7c0-1.1-.9-2-2-2h-6.7l-2.67 2.67Z"/></svg>
                    </button>
                    <button id="switchCameraButton">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-camera-off"><line x1="2" x2="22" y1="2" y2="22"/><path d="M16 16v1a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h2l1.6-2.4"/><path d="M10 7H21a2 2 0 0 1 2 2v8"/><path d="M15 13a3 3 0 1 0-2-2"/></svg>
                    </button>
                </div>
            </div>
            
            <!-- ç€ä¿¡ãƒ¢ãƒ¼ãƒ€ãƒ« -->
            <div id="incoming-call-modal" class="modal">
                <div class="modal-content">
                    <p id="caller-name" class="text-xl font-bold mb-5">Xxxã•ã‚“ã‹ã‚‰é›»è©±ã§ã™</p>
                    <div class="modal-buttons">
                        <button id="answerButton">å¿œç­”</button>
                        <button id="rejectButton">æ‹’å¦</button>
                    </div>
                </div>
            </div>

            <!-- ç€ä¿¡éŸ³ (ãƒ«ãƒ¼ãƒ—å†ç”Ÿã®ãŸã‚) -->
            <audio id="incomingCallSound" loop src="https://assets.mixkit.co/sfx/preview/mixkit-analog-phone-ring-2374.mp3" style="display:none;"></audio>
        </div>
    </div>
    

    <script>
// =========================================================
// 1. åˆæœŸè¨­å®š (ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨Firebaseã‚µãƒ¼ãƒ“ã‚¹)
// =========================================================

// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
let firebaseApp;
let auth;
let db;
let currentUser = null;
let currentCallId = null; 
let localStream = null;
let peerConnection = null;
let currentFacingMode = 'user'; 
let notificationPermissionGranted = false; 

// ğŸš¨ğŸš¨ğŸš¨ ã“ã“ã‚’ã‚ãªãŸã®Firebaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®è¨­å®šã«ç½®ãæ›ãˆã¦ãã ã•ã„ ğŸš¨ğŸš¨ğŸš¨
// Firebase Consoleã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®š > ãƒã‚¤ã‚¢ãƒ—ãƒª > SDK ã®è¨­å®šã¨æ§‹æˆ ã‹ã‚‰å–å¾—
const firebaseConfig = {
    apiKey: "/* YOUR_API_KEY_HERE */",
    authDomain: "/* YOUR_AUTH_DOMAIN_HERE */",
    projectId: "/* YOUR_PROJECT_ID_HERE */",
    // ä»–ã«å¿…è¦ãªè¨­å®šãŒã‚ã‚Œã°ã“ã“ã«è¿½åŠ 
};
// ğŸš¨ğŸš¨ğŸš¨ è¨­å®šã®ç½®ãæ›ãˆã‚’å¿˜ã‚Œãšã«è¡Œã£ã¦ãã ã•ã„ ğŸš¨ğŸš¨ğŸš¨

// Firestoreã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã«åˆã‚ã›ã‚‹ãŸã‚ã®ã‚¢ãƒ—ãƒªIDï¼ˆprojectIdã‚’ä»£ç”¨ï¼‰
const appId = firebaseConfig.projectId;

// TURNã‚µãƒ¼ãƒãƒ¼è¨­å®šã¯ config.js ã‹ã‚‰ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° configuration ã¨ã—ã¦èª­ã¿è¾¼ã¾ã‚Œã¾ã™
if (typeof configuration === 'undefined') {
    console.error("config.js ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ãªã„ã‹ã€TURNã‚µãƒ¼ãƒãƒ¼è¨­å®šãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã®ç„¡æ–™TURNã‚µãƒ¼ãƒãƒ¼ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚");
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ã—ã¦ã€ã‚ªãƒ¼ãƒ—ãƒ³ãƒªãƒ¬ãƒ¼ã‚’ä½¿ç”¨
    var configuration = { 
        iceServers: [
            { urls: 'stun:stun.l.google.com:19302' },
            { urls: 'turn:turn.openrelay.metered.ca:80', username: 'openrelayproject', credential: 'openrelayproject' }
        ]
    };
}


// FirebaseåˆæœŸåŒ– (ã‚°ãƒ­ãƒ¼ãƒãƒ«ãª 'firebase' ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹)
try {
    firebaseApp = firebase.initializeApp(firebaseConfig);
    auth = firebase.auth();
    db = firebase.firestore();
    
    // Firestoreã®è¨­å®šã‚’èª¿æ•´ (æ¨å¥¨è¨­å®šã‚’æœ‰åŠ¹ã«ã™ã‚‹)
    db.settings({
        ignoreUndefinedProperties: true
    });

    // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ã®è¨­å®š (Firestoreåˆ©ç”¨æ™‚æ¨å¥¨)
    firebase.firestore.setLogLevel('debug');

} catch(e) {
    console.error("FirebaseåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:", e);
    document.getElementById('loading-spinner').innerHTML = `<p class="text-red-500">Firebaseã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>`;
}


// =========================================================
// 2. DOMè¦ç´ ã¨ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®åˆæœŸåŒ– (HTMLèª­ã¿è¾¼ã¿å¾Œå®Ÿè¡Œ)
// =========================================================
let authStatusDiv, appContainer, loadingSpinner, usersContainer, 
    signInButton, signUpButton, signOutButton, 
    sendMessageButton, switchCameraButton, hangupButton, 
    answerButton, rejectButton, addFriendButton, friendEmailInput, incomingCallSound,
    localVideo, remoteVideo, callOverlay, callStatus, incomingModal; 

window.onload = function() {
    // DOMè¦ç´ ã®å–å¾—
    authStatusDiv = document.getElementById('auth-status');
    appContainer = document.getElementById('app-container');
    loadingSpinner = document.getElementById('loading-spinner');
    usersContainer = document.getElementById('users-container');

    signInButton = document.getElementById('signInButton');
    signUpButton = document.getElementById('signUpButton');
    signOutButton = document.getElementById('signOutButton');
    sendMessageButton = document.getElementById('sendMessageButton');
    switchCameraButton = document.getElementById('switchCameraButton');
    hangupButton = document.getElementById('hangupButton');
    answerButton = document.getElementById('answerButton');
    rejectButton = document.getElementById('rejectButton');
    addFriendButton = document.getElementById('addFriendButton'); 
    friendEmailInput = document.getElementById('friendEmailInput'); 
    incomingCallSound = document.getElementById('incomingCallSound'); 
    
    localVideo = document.getElementById('localVideo');
    remoteVideo = document.getElementById('remoteVideo');
    callOverlay = document.getElementById('call-overlay');
    callStatus = document.getElementById('call-status');
    incomingModal = document.getElementById('incoming-call-modal');


    // UIã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
    signInButton.addEventListener('click', () => {
        const email = document.getElementById('emailInput').value;
        const password = document.getElementById('passwordInput').value;
        
        // å…¥åŠ›ãƒã‚§ãƒƒã‚¯
        if (!email || !password) {
            showAuthError("ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
            return;
        }

        auth.signInWithEmailAndPassword(email, password)
            .catch(e => {
                console.error("ã‚µã‚¤ãƒ³ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:", e.message);
                showAuthError(`ã‚µã‚¤ãƒ³ã‚¤ãƒ³å¤±æ•—: ${e.code.replace('auth/', '')}`);
            });
    });

    signUpButton.addEventListener('click', () => {
        const email = document.getElementById('emailInput').value;
        const password = document.getElementById('passwordInput').value;
        
        // å…¥åŠ›ãƒã‚§ãƒƒã‚¯ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰é•·ãƒã‚§ãƒƒã‚¯
        if (!email || !password) {
            showAuthError("ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
            return;
        }
        if (password.length < 6) {
            showAuthError("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
            return;
        }

        auth.createUserWithEmailAndPassword(email, password)
            .then(() => {
                // ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—æˆåŠŸå¾Œã€FirebaseãŒè‡ªå‹•çš„ã«ã‚µã‚¤ãƒ³ã‚¤ãƒ³çŠ¶æ…‹ã«ã™ã‚‹ãŸã‚ã€ç‰¹ã«å‡¦ç†ã¯ä¸è¦ã ãŒã€æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                showAuthError("ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ã«æˆåŠŸã—ã¾ã—ãŸï¼è‡ªå‹•çš„ã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã™ã€‚", "green");
            })
            .catch(e => {
                console.error("ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼:", e.message);
                showAuthError(`ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—å¤±æ•—: ${e.code.replace('auth/', '')}`);
            });
    });

    signOutButton.addEventListener('click', () => {
        if (currentUser) {
            // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ™‚ã«usersã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰è‡ªåˆ†ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤ (v8æ§‹æ–‡)
            db.collection('artifacts').doc(appId).collection('public').doc('data').collection('users').doc(currentUser.uid).delete()
              .catch(console.error);
        }
        auth.signOut();
    });

    sendMessageButton.addEventListener('click', sendMessage);
    switchCameraButton.addEventListener('click', switchCamera); 
    hangupButton.addEventListener('click', endCall); 
    answerButton.addEventListener('click', answerCall); 
    rejectButton.addEventListener('click', rejectCall); 
    addFriendButton.addEventListener('click', addFriendByEmail); 

    // Firebaseèªè¨¼çŠ¶æ…‹ã®ç›£è¦–ã‚’é–‹å§‹
    startAuthListener();
}

// èªè¨¼ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºãƒ˜ãƒ«ãƒ‘ãƒ¼ (alertã®ä»£æ›¿)
function showAuthError(message, type = "red") {
    // æ—¢å­˜ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤
    document.querySelectorAll('#auth-status .auth-message').forEach(e => e.remove());

    const errorMsg = document.createElement('p');
    errorMsg.className = `auth-message text-sm mt-2 font-semibold`;
    errorMsg.style.color = type === 'green' ? '#34c759' : '#ff3b30';
    errorMsg.textContent = message;
    authStatusDiv.appendChild(errorMsg);
    setTimeout(() => errorMsg.remove(), 5000);
}


// =========================================================
// 3. èªè¨¼ & ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç† & ãƒ•ãƒ¬ãƒ³ãƒ‰æ©Ÿèƒ½
// =========================================================

function startAuthListener() {
    auth.onAuthStateChanged(async (user) => {
        // èªè¨¼çŠ¶æ…‹ãŒç¢ºå®šã—ãŸæ™‚ç‚¹ã§ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’éè¡¨ç¤ºã«ã™ã‚‹
        loadingSpinner.style.display = 'none';

        if (user) {
            currentUser = user;
            // emailã‚’çŸ­ç¸®ã—ã¦è¡¨ç¤º
            document.getElementById('user-info').textContent = `${user.email.split('@')[0]} (ID: ${user.uid.substring(0, 8)}...)`;
            
            // ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ãªã‚‰ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚’è¡¨ç¤º
            authStatusDiv.style.display = 'none';
            appContainer.style.display = 'flex';

            // é€šçŸ¥æ¨©é™ã‚’è¦æ±‚
            await requestNotificationPermission(); 

            // è‡ªåˆ†ã®æƒ…å ±ã‚’usersã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«ä¿å­˜ (ã‚ªãƒ³ãƒ©ã‚¤ãƒ³é€šçŸ¥ä»£ã‚ã‚Š, v8æ§‹æ–‡)
            const userDocRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('users').doc(user.uid);
            await userDocRef.set({
                email: user.email,
                uid: user.uid,
                // ServerTimestampã‚’ä½¿ç”¨ (v8æ§‹æ–‡)
                lastSeen: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true }).catch(e => console.error("ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ä¿å­˜ã‚¨ãƒ©ãƒ¼:", e));

            startChatListener();   
            startUserListListener(); 
            startIncomingCallListener(); 
        } else {
            currentUser = null;
            // æœªãƒ­ã‚°ã‚¤ãƒ³ãªã‚‰èªè¨¼ç”»é¢ã‚’è¡¨ç¤º
            authStatusDiv.style.display = 'block';
            appContainer.style.display = 'none';
        }
    });
}

// ãƒ–ãƒ©ã‚¦ã‚¶é€šçŸ¥æ¨©é™ã‚’è¦æ±‚ã™ã‚‹é–¢æ•°
async function requestNotificationPermission() {
    if (!('Notification' in window)) {
        console.warn("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯é€šçŸ¥ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚");
        return;
    }

    if (Notification.permission === 'granted') {
        notificationPermissionGranted = true;
        return;
    }

    if (Notification.permission !== 'denied') {
        try {
            const permission = await Notification.requestPermission();
            if (permission === 'granted') {
                notificationPermissionGranted = true;
                console.log("é€šçŸ¥æ¨©é™ãŒè¨±å¯ã•ã‚Œã¾ã—ãŸã€‚");
            } else {
                notificationPermissionGranted = false;
                console.log("é€šçŸ¥æ¨©é™ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚");
            }
        } catch (error) {
            console.error("é€šçŸ¥æ¨©é™ã®è¦æ±‚ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", error);
            notificationPermissionGranted = false;
        }
    }
}

// ãƒ–ãƒ©ã‚¦ã‚¶é€šçŸ¥ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
function displayNotification(title, body) {
    if (notificationPermissionGranted) {
        // ãƒ“ãƒ‡ã‚ªã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ãŒè¡¨ç¤ºä¸­ã€ã¾ãŸã¯ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªå ´åˆã¯é€šçŸ¥ã—ãªã„
        if (document.visibilityState === 'visible' && callOverlay.style.display !== 'flex') {
            return;
        }

        const notification = new Notification(title, {
            body: body,
            icon: 'https://placehold.co/64x64/00c300/ffffff?text=L', 
            vibrate: [200, 100, 200]
        });
        
        notification.onclick = function() {
            window.focus();
            this.close();
        };
    }
}

// ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ãƒ•ãƒ¬ãƒ³ãƒ‰ã‚’è¿½åŠ ã™ã‚‹ (v8æ§‹æ–‡)
async function addFriendByEmail() {
    const email = friendEmailInput.value.trim();
    if (!email || email === currentUser.email) {
        showCustomMessage("ç„¡åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã€ã¾ãŸã¯è‡ªåˆ†è‡ªèº«ã§ã™ã€‚", 'red');
        return;
    }

    // æ—¢å­˜ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤
    document.querySelectorAll('.left-panel .text-red-500').forEach(e => e.remove());

    try {
        // 1. ãã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æŒã¤ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ¤œç´¢
        const usersRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('users');
        const usersSnapshot = await usersRef.where('email', '==', email).get();

        if (usersSnapshot.empty) {
            showCustomMessage(`ãƒ¦ãƒ¼ã‚¶ãƒ¼ ${email} ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚`, 'red');
            return;
        }

        const friendDoc = usersSnapshot.docs[0];
        const friendUid = friendDoc.id;

        // 2. è‡ªåˆ†ã®ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªã‚¹ãƒˆã«è¿½åŠ 
        const friendDocRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('friends').doc(currentUser.uid).collection('list').doc(friendUid);
        await friendDocRef.set({
            uid: friendUid,
            email: email,
            addedAt: firebase.firestore.FieldValue.serverTimestamp() // v8æ§‹æ–‡
        });

        showCustomMessage(`${email.split('@')[0]} ã‚’ãƒ•ãƒ¬ãƒ³ãƒ‰ã«è¿½åŠ ã—ã¾ã—ãŸï¼`, 'green');
        friendEmailInput.value = '';

    } catch (e) {
        console.error("ãƒ•ãƒ¬ãƒ³ãƒ‰è¿½åŠ ã‚¨ãƒ©ãƒ¼:", e);
        showCustomMessage("ãƒ•ãƒ¬ãƒ³ãƒ‰ã®è¿½åŠ ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚", 'red');
    }
}

// ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºï¼ˆalertã®ä»£æ›¿ï¼‰
function showCustomMessage(message, type) {
    const container = document.querySelector('.left-panel');
    let msgDiv = document.createElement('div');
    msgDiv.textContent = message;
    msgDiv.className = `p-2 mt-2 rounded-lg text-sm text-white font-semibold`;
    msgDiv.style.backgroundColor = type === 'green' ? '#34c759' : '#ff3b30';
    container.insertBefore(msgDiv, container.querySelector('.users-list'));

    setTimeout(() => {
        msgDiv.remove();
    }, 4000);
}


// ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªã‚¹ãƒˆã®ç›£è¦–ã¨è¡¨ç¤º (v8æ§‹æ–‡)
function startUserListListener() {
    const onlineUsers = {}; 
    let friends = {};       

    // 1. ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç›£è¦–
    const usersRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('users');
    usersRef.onSnapshot(onlineSnapshot => {
        Object.keys(onlineUsers).forEach(key => delete onlineUsers[key]); 
        onlineSnapshot.forEach(doc => {
            const userData = doc.data();
            // æœ€çµ‚æ›´æ–°æ™‚é–“ãŒ5åˆ†ä»¥å†…ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã¨è¦‹ãªã™
            const now = Date.now();
            const lastSeenTime = userData.lastSeen ? (userData.lastSeen.toDate ? userData.lastSeen.toDate().getTime() : now) : now;
            
            if (userData.uid !== currentUser.uid && (now - lastSeenTime) < 300000) {
                onlineUsers[userData.uid] = userData;
            }
        });
        renderFriendList(friends, onlineUsers);
    });

    // 2. è‡ªåˆ†ã®ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªã‚¹ãƒˆã®ç›£è¦–
    const friendsListRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('friends').doc(currentUser.uid).collection('list');
    friendsListRef.onSnapshot(friendSnapshot => {
        Object.keys(friends).forEach(key => delete friends[key]);
        friendSnapshot.forEach(doc => {
            const friendData = doc.data();
            friends[friendData.uid] = friendData;
        });
        renderFriendList(friends, onlineUsers);
    });
}

// ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªã‚¹ãƒˆã®DOMæç”»
function renderFriendList(friends, onlineUsers) {
    usersContainer.innerHTML = '';
    
    const friendUids = Object.keys(friends);

    if (friendUids.length === 0) {
        usersContainer.innerHTML = '<p style="text-align:center; color:#999; margin-top:20px;">ã¾ã ãƒ•ãƒ¬ãƒ³ãƒ‰ãŒã„ã¾ã›ã‚“ã€‚ã€Œãƒ•ãƒ¬ãƒ³ãƒ‰ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã€ã‚’å…¥åŠ›ã—ã¦è¿½åŠ ã—ã¾ã—ã‚‡ã†ã€‚</p>';
        return;
    }

    friendUids.forEach(uid => {
        const friendData = friends[uid];
        const isOnline = !!onlineUsers[uid]; 
        const displayData = isOnline ? onlineUsers[uid] : friendData;
        
        const div = document.createElement('div');
        div.className = `user-item ${isOnline ? 'online' : 'offline'}`;
        // onclické–¢æ•°ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å®šç¾©ã•ã‚ŒãŸé–¢æ•°ã¨ã—ã¦å‘¼ã³å‡ºã™
        div.innerHTML = `
            <div class="user-info-status">
                <span class="online-dot"></span>
                <span class="font-semibold">${displayData.email.split('@')[0]}</span>
                <span class="text-xs text-gray-500 ml-2">${isOnline ? '(Online)' : '(Offline)'}</span>
            </div>
            ${isOnline 
                ? `<button onclick="startCall('${displayData.uid}', '${displayData.email}')">ğŸ“ é€šè©±</button>`
                : `<button onclick="removeFriend('${displayData.uid}', '${displayData.email}')" style="background-color: #ff3b30;">å‰Šé™¤</button>`
            }
        `;
        usersContainer.appendChild(div);
    });
}

// ãƒ•ãƒ¬ãƒ³ãƒ‰å‰Šé™¤ (v8æ§‹æ–‡)
window.removeFriend = async (friendUid, friendEmail) => {
    // ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ« (ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°)ã®ä»£æ›¿
    const confirmed = window.prompt(`${friendEmail.split('@')[0]} ã•ã‚“ã‚’ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ (ã€Œå‰Šé™¤ã€ã¨å…¥åŠ›)`);
    if (confirmed && confirmed.toLowerCase() === 'å‰Šé™¤') {
        try {
            const friendDocRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('friends').doc(currentUser.uid).collection('list').doc(friendUid);
            await friendDocRef.delete();
            showCustomMessage(`${friendEmail.split('@')[0]} ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚`, 'green');
        } catch(e) {
            console.error("ãƒ•ãƒ¬ãƒ³ãƒ‰å‰Šé™¤ã‚¨ãƒ©ãƒ¼:", e);
            showCustomMessage("ãƒ•ãƒ¬ãƒ³ãƒ‰å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚", 'red');
        }
    }
}


// =========================================================
// 4. ãƒãƒ£ãƒƒãƒˆ
// =========================================================

// ãƒãƒ£ãƒƒãƒˆé€ä¿¡ (v8æ§‹æ–‡)
function sendMessage() {
    const input = document.getElementById('messageInput');
    const text = input.value.trim();
    if (text && currentUser) {
        const chatCollectionRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('chats');
        chatCollectionRef.add({
            text: text,
            uid: currentUser.uid,
            email: currentUser.email,
            timestamp: firebase.firestore.FieldValue.serverTimestamp() // v8æ§‹æ–‡
        });
        input.value = '';
    }
}

// ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ "hh:mm" å½¢å¼ã«æ•´å½¢ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
function formatTimestamp(timestamp) {
    if (!timestamp) return '';
    // Firestore Timestampã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰Dateã‚’å–å¾—
    const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
    const hours = date.getHours().toString().padStart(2, '0');
    const minutes = date.getMinutes().toString().padStart(2, '0');
    return `${hours}:${minutes}`;
}

// ãƒãƒ£ãƒƒãƒˆå—ä¿¡ (LINEé¢¨è¡¨ç¤º) (v8æ§‹æ–‡)
function startChatListener() {
    const chatArea = document.getElementById('chat-area');
    const chatCollectionRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('chats');
    // ã‚¯ã‚¨ãƒª: ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã§æ˜‡é †ã‚½ãƒ¼ãƒˆã—ã€æœ€æ–°50ä»¶ã«åˆ¶é™
    const q = chatCollectionRef.orderBy('timestamp', 'asc').limit(50);
    
    q.onSnapshot(snapshot => {
        let newMessages = [];

        snapshot.docChanges().forEach(change => {
            if (change.type === 'added') {
                const data = change.doc.data();
                // è‡ªåˆ†ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä»¥å¤–ã‚’æ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ã—ã¦æ‰±ã†
                if (data.uid !== currentUser.uid && data.text) {
                    newMessages.push(data);
                }
            }
        });

        // æ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚Œã°é€šçŸ¥
        if (newMessages.length > 0) {
            newMessages.forEach(data => {
                const senderName = data.email ? data.email.split('@')[0] : 'ã‚²ã‚¹ãƒˆ';
                displayNotification(`ãƒãƒ£ãƒƒãƒˆ (${senderName})`, data.text);
            });
        }

        // UIã®å†æç”»
        chatArea.innerHTML = '';
        snapshot.forEach(doc => {
            const data = doc.data();
            
            if (!data.text || typeof data.text !== 'string') return; 

            try { 
                const isMe = data.uid === currentUser.uid;
                const userName = data.email ? data.email.split('@')[0] : 'ã‚²ã‚¹ãƒˆ';
                const timeString = formatTimestamp(data.timestamp); 
                
                const rowDiv = document.createElement('div');
                rowDiv.className = `message-row ${isMe ? 'my-message-row' : 'other-message-row'}`;
                
                const timeSpan = document.createElement('span');
                timeSpan.className = 'timestamp';
                timeSpan.textContent = timeString;

                const msgDiv = document.createElement('div');
                msgDiv.className = 'message';
                
                if (!isMe) {
                    const nameSpan = document.createElement('span');
                    nameSpan.className = 'sender-name';
                    nameSpan.textContent = userName;
                    msgDiv.appendChild(nameSpan);
                }
                
                const textNode = document.createTextNode(data.text);
                msgDiv.appendChild(textNode);
                
                // è‡ªåˆ†ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯æ™‚é–“è¡¨ç¤ºã‚’å·¦ã«ã€ç›¸æ‰‹ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯æ™‚é–“è¡¨ç¤ºã‚’å³ã«
                if (isMe) {
                    rowDiv.appendChild(timeSpan);
                    rowDiv.appendChild(msgDiv);
                } else {
                    rowDiv.appendChild(msgDiv);
                    rowDiv.appendChild(timeSpan);
                }

                chatArea.appendChild(rowDiv);
            } catch (e) {
                console.error("ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¡¨ç¤ºä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:", e, data);
            }
        });
        // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æœ€ä¸‹éƒ¨ã«ç§»å‹•
        chatArea.scrollTop = chatArea.scrollHeight;
    });
}


// =========================================================
// 5. 1å¯¾1 WebRTC é€šè©±æ©Ÿèƒ½
// =========================================================

// ã‚«ãƒ¡ãƒ©å–å¾—é–¢æ•° (facingModeå¯¾å¿œ)
async function getLocalStream() {
    try {
        const constraints = {
            audio: true,
            // ã‚«ãƒ¡ãƒ©åˆ‡ã‚Šæ›¿ãˆã‚’å¯èƒ½ã«ã™ã‚‹ãŸã‚ã« facingMode ã‚’ä½¿ç”¨
            video: { facingMode: currentFacingMode }
        };
        localStream = await navigator.mediaDevices.getUserMedia(constraints);
        localVideo.srcObject = localStream;
        return true;
    } catch (e) {
        console.error("ã‚«ãƒ¡ãƒ©å–å¾—ã‚¨ãƒ©ãƒ¼", e);
        return false;
    }
}

// é€šè©±é–‹å§‹ (ç™ºä¿¡)
window.startCall = async (targetUid, targetEmail) => {
    if (!await getLocalStream()) {
        showCustomMessage("ã‚«ãƒ¡ãƒ©ã¾ãŸã¯ãƒã‚¤ã‚¯ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚", 'red');
        return;
    }
    
    // 1å¯¾1ç”¨ã®é€šè©±IDã‚’ä½œæˆ (è¾æ›¸é †ã§ä¸¦ã¹æ›¿ãˆ)
    const uids = [currentUser.uid, targetUid].sort();
    currentCallId = `${uids[0]}_${uids[1]}`;
    
    // UIè¡¨ç¤º
    callOverlay.style.display = 'flex';
    callStatus.textContent = `${targetEmail.split('@')[0]} ã•ã‚“ã«ç™ºä¿¡ä¸­...`;
    
    // PeerConnectionã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    setupPeerConnection();
    
    // Firestoreãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå‚ç…§ (v8æ§‹æ–‡)
    const callDocRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('calls').doc(currentCallId);
    
    // éå»ã®ã‚´ãƒŸãƒ‡ãƒ¼ã‚¿ã‚’æƒé™¤ (Candidatesã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤)
    const candidatesRef = callDocRef.collection('candidates');
    // Candidatesã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å†…ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤ã™ã‚‹ãŸã‚ã®ãƒãƒƒãƒå‡¦ç†
    const candidatesSnapshot = await candidatesRef.get();
    const batch = db.batch();
    candidatesSnapshot.forEach(doc => batch.delete(doc.ref));
    await batch.commit();

    // Offerä½œæˆ
    const offer = await peerConnection.createOffer();
    await peerConnection.setLocalDescription(offer);
    
    // ç™ºä¿¡æƒ…å ±ã‚’æ›¸ãè¾¼ã¿ (v8æ§‹æ–‡)
    await callDocRef.set({
        offer: { type: offer.type, sdp: offer.sdp },
        callerUid: currentUser.uid,
        calleeUid: targetUid, 
        answer: null
    });

    // Answerå¾…ã¡å—ã‘ (v8æ§‹æ–‡)
    const unsubscribe = callDocRef.onSnapshot(async (snapshot) => {
        const data = snapshot.data();
        
        // AnswerãŒè¨­å®šã•ã‚Œã€ã‹ã¤ã¾ã ãƒªãƒ¢ãƒ¼ãƒˆDescriptionãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆ
        if (data && data.answer && !peerConnection.currentRemoteDescription) {
            try {
                const answerDesc = new RTCSessionDescription(data.answer);
                await peerConnection.setRemoteDescription(answerDesc);
                callStatus.textContent = 'æ¥ç¶šã—ã¾ã—ãŸ';
                unsubscribe();
            } catch (e) {
                console.error("Answerè¨­å®šã‚¨ãƒ©ãƒ¼:", e);
                callStatus.textContent = 'æ¥ç¶šã‚¨ãƒ©ãƒ¼';
                // æ¥ç¶šå¤±æ•—æ™‚ã¯é€šè©±ã‚’çµ‚äº†
                setTimeout(endCall, 2000); 
                unsubscribe();
            }
        }
        // é€šè©±ãƒ‡ãƒ¼ã‚¿ãŒå‰Šé™¤ã•ã‚ŒãŸå ´åˆ (ç›¸æ‰‹ãŒæ‹’å¦/åˆ‡æ–­)
        if (!data || !data.offer) {
            if(callOverlay.style.display === 'flex') {
                callStatus.textContent = 'ç›¸æ‰‹ãŒé€šè©±ã‚’çµ‚äº†ã—ã¾ã—ãŸ';
                setTimeout(endCall, 2000);
            }
            unsubscribe();
        }
    });
};

// ç€ä¿¡ç›£è¦– (è‡ªåˆ†å®›ã¦ã®é›»è©±ã ã‘ã‚’æ‹¾ã†) (v8æ§‹æ–‡)
function startIncomingCallListener() {
    const callsCollectionRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('calls');
    
    callsCollectionRef.onSnapshot(snapshot => {
        snapshot.docChanges().forEach(async change => {
            const data = change.doc.data();

            if (data.calleeUid === currentUser.uid && data.offer && !data.answer) {
                // ç€ä¿¡ã‚’æ¤œå‡º
                if (change.type === 'added' || (change.type === 'modified' && !incomingCallId)) {
                    if (callOverlay.style.display !== 'flex' && incomingModal.style.display !== 'flex') {
                        try { 
                            incomingCallSound.play(); 
                        } catch(e) { 
                            console.warn("ç€ä¿¡éŸ³å†ç”Ÿã‚¨ãƒ©ãƒ¼:", e); 
                        }
                        
                        // ç™ºä¿¡è€…æƒ…å ±ã‚’å–å¾—
                        const callerDocRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('users').doc(data.callerUid);
                        const docSnap = await callerDocRef.get();
                        
                        const callerEmail = docSnap.exists ? docSnap.data().email : 'ä¸æ˜ãªãƒ¦ãƒ¼ã‚¶ãƒ¼';
                        const callerName = callerEmail.split('@')[0];
                        
                        displayNotification(`ğŸ“ ç€ä¿¡ (${callerName}ã•ã‚“)`, `${callerName}ã•ã‚“ã‹ã‚‰é€šè©±ãŒã‹ã‹ã£ã¦ãã¾ã—ãŸã€‚`);
                        
                        showIncomingCallModal(change.doc.id, callerName);
                    }
                }
            } else if (!data.offer && change.doc.id === incomingCallId) {
                // ç™ºä¿¡è€…ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ãŸã“ã¨ã‚’æ¤œå‡º
                rejectCall(false); // UIã‚’é–‰ã˜ã‚‹ãŒã€Firestoreã¯å‰Šé™¤ã—ãªã„ (æ—¢ã«å‰Šé™¤æ¸ˆã¿ã®ãŸã‚)
                showCustomMessage("ç›¸æ‰‹ãŒé€šè©±ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸã€‚", 'red');
            }
        });
    });
}

// ç€ä¿¡ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
let incomingCallId = null;
function showIncomingCallModal(callId, callerName) {
    incomingCallId = callId;
    document.getElementById('caller-name').textContent = `${callerName} ã•ã‚“ã‹ã‚‰é›»è©±ã§ã™`;
    incomingModal.style.display = 'flex'; 
}

// å¿œç­”ãƒœã‚¿ãƒ³å‡¦ç† (v8æ§‹æ–‡)
async function answerCall() {
    incomingModal.style.display = 'none';
    incomingCallSound.pause(); 
    incomingCallSound.currentTime = 0;
    
    currentCallId = incomingCallId;
    incomingCallId = null; // å¿œç­”ã—ãŸã®ã§ãƒªã‚»ãƒƒãƒˆ
    
    if (!await getLocalStream()) {
        showCustomMessage("ã‚«ãƒ¡ãƒ©ã¾ãŸã¯ãƒã‚¤ã‚¯ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚", 'red');
        return;
    }
    
    callOverlay.style.display = 'flex';
    callStatus.textContent = 'æ¥ç¶šä¸­...';
    
    setupPeerConnection();
    
    const callDocRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('calls').doc(currentCallId);
    const docSnap = await callDocRef.get();
    
    if (!docSnap.exists || !docSnap.data().offer) {
        console.error("é€šè©±ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ãªã„ã‹ã€OfferãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
        endCall();
        return;
    }

    const data = docSnap.data();
    
    // Offerè¨­å®š
    await peerConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
    
    // Answerä½œæˆ
    const answer = await peerConnection.createAnswer();
    await peerConnection.setLocalDescription(answer);
    
    // Answerã‚’Firestoreã«æ›¸ãè¾¼ã¿ (v8æ§‹æ–‡)
    await callDocRef.set({
        answer: { type: answer.type, sdp: answer.sdp }
    }, { merge: true });
}

// æ‹’å¦ãƒœã‚¿ãƒ³å‡¦ç† (v8æ§‹æ–‡)
function rejectCall(deleteFirestore = true) {
    incomingModal.style.display = 'none';
    incomingCallSound.pause(); 
    incomingCallSound.currentTime = 0;

    if (incomingCallId && deleteFirestore) {
         // é€šè©±ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã—ã¦ç›¸æ‰‹ã«åˆ‡æ–­ã‚’é€šçŸ¥
         const callDocRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('calls').doc(incomingCallId);
         callDocRef.delete().catch(console.error);
    }
    incomingCallId = null;
}


// PeerConnectionå…±é€šã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— (v8æ§‹æ–‡)
function setupPeerConnection() {
    if (peerConnection) peerConnection.close();
    // configuration å¤‰æ•°ã¯ config.js ã‹ã‚‰èª­ã¿è¾¼ã¾ã‚Œã¾ã™
    peerConnection = new RTCPeerConnection(configuration);
    
    if (localStream) {
        localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
    }
    
    // ãƒªãƒ¢ãƒ¼ãƒˆãƒˆãƒ©ãƒƒã‚¯ã‚’å—ä¿¡
    peerConnection.ontrack = event => {
        remoteVideo.srcObject = event.streams[0];
        callStatus.textContent = 'æ¥ç¶šã—ã¾ã—ãŸ';
    };
    
    // ICE Candidateå‡¦ç†
    const callDocRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('calls').doc(currentCallId);
    const candidatesCollectionRef = callDocRef.collection('candidates');
    
    // ICE Candidateã‚’é€ä¿¡
    peerConnection.onicecandidate = event => {
        if (event.candidate) {
            // Firestoreã«Candidateã‚’è¿½åŠ  (v8æ§‹æ–‡)
            candidatesCollectionRef.add(event.candidate.toJSON());
        }
    };
    
    // ICE Candidateã®å—ä¿¡ (v8æ§‹æ–‡)
    candidatesCollectionRef.onSnapshot(snapshot => {
        snapshot.docChanges().forEach(async change => {
            if (change.type === 'added') {
                const candidate = new RTCIceCandidate(change.doc.data());
                // ãƒªãƒ¢ãƒ¼ãƒˆè¨­å®šå¾Œã®ã¿Candidateã‚’è¿½åŠ 
                if (peerConnection && peerConnection.remoteDescription) {
                    try { 
                        // ICE candidateã®è¿½åŠ å‰ã«ãƒ”ã‚¢ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ã®çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
                        if (peerConnection.signalingState !== 'closed') {
                            await peerConnection.addIceCandidate(candidate); 
                        }
                    }
                    catch (e) { 
                        // ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã¯å‡ºã™ãŒå‡¦ç†ã¯ç¶™ç¶š (é€šå¸¸ã€æ—¢ã«è¨­å®šã•ã‚ŒãŸCandidateãŒé‡è¤‡ã—ãŸå ´åˆãªã©ã«ç™ºç”Ÿ)
                        console.error("Candidateè¿½åŠ ã‚¨ãƒ©ãƒ¼:", e); 
                    }
                }
            }
        });
    });
    
    // åˆ‡æ–­ç›£è¦–
    peerConnection.onconnectionstatechange = () => {
        // 'connected'ã¯æ—¢ã«ontrackã§å‡¦ç†
        if (peerConnection.connectionState === 'disconnected' || peerConnection.connectionState === 'failed' || peerConnection.connectionState === 'closed') {
            if (callOverlay.style.display === 'flex') {
                callStatus.textContent = 'æ¥ç¶šãŒåˆ‡ã‚Œã¾ã—ãŸ';
                setTimeout(endCall, 2000);
            }
        }
    };
}


// =========================================================
// 6. ã‚«ãƒ¡ãƒ©åˆ‡ã‚Šæ›¿ãˆ & é€šè©±çµ‚äº†
// =========================================================

// ã‚«ãƒ¡ãƒ©åˆ‡ã‚Šæ›¿ãˆ (ã‚¹ãƒãƒ›ç”¨)
async function switchCamera() {
    currentFacingMode = currentFacingMode === 'user' ? 'environment' : 'user';
    
    if (localStream) {
        // å¤ã„ãƒˆãƒ©ãƒƒã‚¯ã‚’åœæ­¢
        localStream.getTracks().forEach(track => track.stop());
    }
    
    const success = await getLocalStream();

    if (success) {
        // PeerConnectionã®æ˜ åƒãƒˆãƒ©ãƒƒã‚¯ã‚’æ–°ã—ã„ãƒˆãƒ©ãƒƒã‚¯ã«å·®ã—æ›¿ãˆã‚‹
        if (peerConnection && localStream) {
            const videoTrack = localStream.getVideoTracks()[0];
            const sender = peerConnection.getSenders().find(s => s.track && s.track.kind === 'video');
            if (sender) {
                // SenderãŒå­˜åœ¨ã™ã‚Œã°ãƒˆãƒ©ãƒƒã‚¯ã‚’ç½®æ›
                sender.replaceTrack(videoTrack);
            } else {
                // SenderãŒå­˜åœ¨ã—ãªã„å ´åˆã¯æ–°ã—ã„ãƒˆãƒ©ãƒƒã‚¯ã‚’è¿½åŠ 
                peerConnection.addTrack(videoTrack, localStream);
            }
        }
    }
}

// é€šè©±çµ‚äº†
function endCall() {
    // 1. WebRTCãƒªã‚½ãƒ¼ã‚¹ã®è§£æ”¾
    if (peerConnection) peerConnection.close();
    if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
    }
    
    // 2. é€šè©±IDãŒã‚ã‚Œã°ã€Firestoreã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã—ã¦ç›¸æ‰‹ã«åˆ‡æ–­ã‚’é€šçŸ¥ (v8æ§‹æ–‡)
    if (currentCallId) {
        const callDocRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('calls').doc(currentCallId);
        callDocRef.delete().catch(console.error);
    }
    
    // 3. UIãƒªã‚»ãƒƒãƒˆ
    callOverlay.style.display = 'none';
    incomingModal.style.display = 'none';
    incomingCallSound.pause(); 
    incomingCallSound.currentTime = 0;
    
    // 4. ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã®ãƒªã‚»ãƒƒãƒˆ
    localStream = null;
    peerConnection = null;
    currentCallId = null;
    incomingCallId = null;

    // 5. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆã‚’å†èª­ã¿è¾¼ã¿ (ã‚ªãƒ³ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ã®æ›´æ–°ã®ãŸã‚)
    // ãƒªã‚¹ãƒŠãƒ¼ã¯auth listenerã«ã‚ˆã£ã¦èµ·å‹•ã—ã¦ã„ã‚‹ãŸã‚ã€å†èµ·å‹•ã¯ä¸è¦ã ãŒã€UIã®å³æ™‚æ›´æ–°ã®ãŸã‚å¼·åˆ¶çš„ã«å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’è©¦ã¿ã‚‹
    document.getElementById('users-container').innerHTML = '';
    if (currentUser) {
        startUserListListener();
    }
}

    </script>
</body>
</html>


